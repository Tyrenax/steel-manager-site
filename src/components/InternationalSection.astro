---
import { Image } from 'astro:assets';

const countries = [
  { flag: '/images/60.png', name: 'Belgique', lat: 50.85, lng: 4.35 },
  { flag: '/images/61.png', name: 'France', lat: 46.60, lng: 2.33 },
  { flag: '/images/62.png', name: 'Pays-Bas', lat: 52.13, lng: 5.29 },
  { flag: '/images/63.png', name: 'Allemagne', lat: 51.16, lng: 10.45 },
  { flag: '/images/64.png', name: 'Pologne', lat: 51.92, lng: 19.15 },
  { flag: '/images/65.png', name: 'Brésil', lat: -14.24, lng: -51.93 },
  { flag: '/images/Algerie.png', name: 'Algérie', lat: 28.03, lng: 1.66 },
  { flag: '/images/arabie.png', name: 'Arabie saoudite', lat: 23.89, lng: 45.08 },
  { flag: '/images/autriche.png', name: 'Autriche', lat: 47.52, lng: 14.55 },
  { flag: '/images/suisse.png', name: 'Suisse', lat: 46.82, lng: 8.23 },
];
---

<section class="section-spacing relative overflow-hidden section-anchor-line" style="background: linear-gradient(180deg, #0a0e1a 0%, #0d1322 40%, #0a0e1a 100%);">
  <div class="max-w-6xl mx-auto px-4 sm:px-6 lg:px-8 relative z-10">
    <div class="grid lg:grid-cols-[1.1fr_0.9fr] gap-8 lg:gap-10 items-center">
      <div data-aos="fade-right" data-aos-duration="400">
        <span class="inline-flex items-center gap-1.5 px-4 py-2 text-sm font-medium rounded-md bg-[#009CFF]/10 text-[#009CFF] border border-[#009CFF]/20 mb-5">International</span>
        <h2 class="text-4xl sm:text-5xl font-bold text-white mb-4 leading-tight">
          Une présence <span style="background: linear-gradient(135deg, #009CFF, #06d6a0); -webkit-background-clip: text; -webkit-text-fill-color: transparent;">internationale</span>
        </h2>
        <p class="text-white/60 text-lg leading-relaxed mb-7 max-w-2xl">
          Nos solutions accompagnent des industriels à travers l'Europe et au-delà. Une même méthode, adaptée à chaque réalité locale.
        </p>

        <div class="grid sm:grid-cols-2 gap-3 mb-7">
          {countries.map((country, index) => (
            <div
              class="country-row"
              data-aos="fade-up"
              data-aos-delay={index * 45}
              data-lat={country.lat}
              data-lng={country.lng}
              style="cursor: pointer;"
            >
              <div class="w-11 h-11 rounded-full overflow-hidden border-2 border-white/10 shadow-sm flex-shrink-0">
                <Image
                  src={country.flag}
                  alt={country.name}
                  width={44}
                  height={44}
                  class="w-full h-full object-cover"
                />
              </div>
              <p class="text-white font-semibold text-sm">{country.name}</p>
            </div>
          ))}
        </div>

        <div class="inline-flex items-center gap-3 px-5 py-3 rounded-xl border border-white/10 shadow-sm" style="background: rgba(255,255,255,0.04);">
          <div class="text-3xl font-bold text-[#009CFF]">150+</div>
          <div class="text-sm text-white/50 leading-tight">projets déployés<br/>à l'international</div>
        </div>
      </div>

      <!-- Globe 3D hologramme -->
      <div
        class="relative intl-visual"
        data-aos="fade-left"
        data-aos-duration="450"
      >
        <div id="earth-globe">
          <div id="earth-glow"></div>
        </div>
      </div>
    </div>
  </div>
</section>

<style>
  .country-row {
    display: flex;
    align-items: center;
    gap: 0.7rem;
    padding: 0.55rem 0.65rem;
    border-radius: 12px;
    border: 1px solid rgba(255, 255, 255, 0.08);
    background: rgba(255, 255, 255, 0.04);
    transition: transform 0.2s ease, border-color 0.2s ease, box-shadow 0.2s ease;
  }

  .country-row:hover,
  .country-row--active {
    transform: translateY(-1px);
    border-color: rgba(0, 156, 255, 0.3);
    box-shadow: 0 10px 16px -14px rgba(0, 156, 255, 0.3);
  }

  #earth-globe {
    width: 100%;
    aspect-ratio: 1;
    max-width: 420px;
    margin: 0 auto;
    position: relative;
    overflow: hidden;
    opacity: 0;
    transition: opacity 1.5s ease-in;
  }

  #earth-globe:global(.earth-ready) {
    opacity: 1;
  }

  #earth-globe::before {
    content: none;
  }

  #earth-glow {
    position: absolute;
    top: 50%;
    left: 50%;
    width: 100%;
    height: 100%;
    transform: translate(-50%, -50%);
    background: radial-gradient(ellipse at center, rgba(0,156,255,0.05) 25%, rgba(0,156,255,0.12) 53%, rgba(0,156,255,0.05) 56%, rgba(0,156,255,0) 70%);
    z-index: 200;
    pointer-events: none;
  }

  @media (min-width: 1024px) {
    .intl-visual {
      margin-top: 0;
    }
  }
</style>

<script is:inline src="/js/miniature.earth.core.js"></script>
<script is:inline>
  function initHologramGlobe() {
    const container = document.getElementById('earth-globe');
    if (!container || container.dataset.initialized) return;
    container.dataset.initialized = 'true';

    window.__hologramEarth = null;
    var myearth = new Earth('earth-globe', {
      location: { lat: 48, lng: 10 },
      light: 'none',
      mapImage: '/images/hologram/hologram-map.svg',
      transparent: true,
      autoRotate: true,
      autoRotateSpeed: 0.8,
      autoRotateDelay: 100,
      autoRotateStart: 1500,
      zoom: 1.0,
      enableZoom: true,
      zoomSpeed: 0.5,
    });

    myearth.addEventListener('ready', function () {
      window.__hologramEarth = myearth;
      this.startAutoRotate();

      // Marqueurs pour les pays présents
      var markers = [
        { lat: 50.85, lng: 4.35, label: 'Belgique' },
        { lat: 46.60, lng: 2.33, label: 'France' },
        { lat: 52.13, lng: 5.29, label: 'Pays-Bas' },
        { lat: 51.16, lng: 10.45, label: 'Allemagne' },
        { lat: 51.92, lng: 19.15, label: 'Pologne' },
        { lat: -14.24, lng: -51.93, label: 'Brésil' },
        { lat: 28.03, lng: 1.66, label: 'Algérie' },
        { lat: 23.89, lng: 45.08, label: 'Arabie saoudite' },
        { lat: 47.52, lng: 14.55, label: 'Autriche' },
        { lat: 46.82, lng: 8.23, label: 'Suisse' },
      ];

      // Lignes de connexion entre les pays
      var connections = [
        [50.85, 4.35, 46.60, 2.33],
        [50.85, 4.35, 52.13, 5.29],
        [50.85, 4.35, 51.16, 10.45],
        [50.85, 4.35, 51.92, 19.15],
        [50.85, 4.35, -14.24, -51.93],
        [50.85, 4.35, 28.03, 1.66],
        [50.85, 4.35, 23.89, 45.08],
        [50.85, 4.35, 47.52, 14.55],
        [50.85, 4.35, 46.82, 8.23],
        [46.60, 2.33, 51.16, 10.45],
        [52.13, 5.29, 51.16, 10.45],
        [51.16, 10.45, 51.92, 19.15],
        [46.82, 8.23, 47.52, 14.55],
        [46.60, 2.33, 28.03, 1.66],
      ];

      var line = {
        color: '#009CFF',
        opacity: 0.35,
        hairline: true,
        offset: -0.5,
      };

      for (var i in connections) {
        line.locations = [
          { lat: connections[i][0], lng: connections[i][1] },
          { lat: connections[i][2], lng: connections[i][3] },
        ];
        this.addLine(line);
      }

      // Marqueurs lumineux sur chaque pays
      for (var m = 0; m < markers.length; m++) {
        this.addSprite({
          image: '/images/hologram/hologram-shine.svg',
          location: { lat: markers[m].lat, lng: markers[m].lng },
          scale: 0.4,
          offset: -0.5,
          opacity: 0.7,
        });
      }

      // Sprites animés
      var sprites = [];
      for (var s = 0; s < 8; s++) {
        sprites[s] = this.addSprite({
          image: '/images/hologram/hologram-shine.svg',
          scale: 0.01,
          offset: -0.5,
          opacity: 0.5,
        });
        pulse(s);
      }

      function pulse(index) {
        var loc = markers[Math.floor(Math.random() * markers.length)];
        sprites[index].location = { lat: loc.lat, lng: loc.lng };
        sprites[index].animate('scale', 0.5, {
          duration: 320,
          complete: function () {
            this.animate('scale', 0.01, {
              duration: 320,
              complete: function () {
                setTimeout(function () { pulse(index); }, 100 + Math.random() * 300);
              },
            });
          },
        });
      }
    });
  }

  // Click sur un pays → rotation du globe
  document.querySelectorAll('.country-row[data-lat]').forEach(function(row) {
    row.addEventListener('click', function() {
      var earth = window.__hologramEarth;
      if (!earth) return;
      var lat = parseFloat(this.dataset.lat);
      var lng = parseFloat(this.dataset.lng);
      earth.resetAutoRotate();
      earth.goTo({ lat: lat, lng: lng }, { duration: 1000 });
      setTimeout(function() { earth.startAutoRotate(); }, 4000);

      // Highlight actif
      document.querySelectorAll('.country-row').forEach(function(r) { r.classList.remove('country-row--active'); });
      this.classList.add('country-row--active');
    });
  });

  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initHologramGlobe);
  } else {
    initHologramGlobe();
  }
  document.addEventListener('astro:page-load', initHologramGlobe);
</script>
